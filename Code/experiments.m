clear 
close all

res = [0.036910130954882  -0.000221958389188
   0.047503446080842  -0.000029650450598
   0.150494863436715   0.000282681135587
  -0.128195263108772  -0.000001602680207
   0.851521542687032   0.000574800023936
  -0.147120734558180  -0.000148466746488
  -0.284825662677866   0.000164769561880
  -0.110988542625614  -0.000277912792727
  -0.175782556225644   0.000328504696324
  -0.088753908556372   0.000106930330150
  -0.110770682942730  -0.000188392227716
   0.008226057591656  -0.000120004104222
   0.108534094934394  -0.000478998551546
   0.058944104918389   0.000401706964492
  -0.067209796163218  -0.000318842455755
   0.224654891817670  -0.000657609061080
   0.098154100097622  -0.001112848783467
  -0.098157056549925  -0.000571330926240
  -0.151746453840917   0.000483573382541
   0.001900834326931  -0.000111445064090
  -0.012420007421748  -0.000351416512437
  -0.045067541027032   0.000456437426457
  -0.072574932299711   0.000182387917078
  -0.155675886925470  -0.000063343682077
  -0.008939422797547   0.000042976953247
  -0.154581821785929  -0.000571297152165
  -0.112837768132776  -0.000147648683897
  -0.107344413333333  -0.000145539552014
  -0.101548636831768   0.000479491264148
   0.038992097344710   0.000082549118556
  -0.001714975382015   0.000309039100282
  -0.168768068509997  -0.000322021819817
   0.085049723060005   0.000150291542470
  -0.240028687441090  -0.000303365138276
  -0.052074934444791  -0.000458832667975
  -0.007539310759343   0.000225136379574
  -0.010562798017869  -0.000035158583052
   0.156931410899894  -0.000001845543536
   0.062423348775882   0.000782877931729
   0.055226428466950  -0.000092802759013
  -0.052170589196206   0.000015914283994
   0.170543142570454  -0.000136480993076
   0.028603863662092   0.000746789255235
   0.186252422855201   0.000223170843208
   0.109751459088336  -0.000136735526877
  -0.207243478224902   0.000165349457991
   0.013089344758871   0.000044636610730
   0.317714088655729   0.000347813119892
   0.080222978705033   0.000663793324485
   0.023713542513184  -0.000056053926576
  -0.115377608471140  -0.000119758419400
  -0.041487071132671   0.000404295005636
   0.030566523334096   0.000668280872407
   0.086180225235025  -0.000510594583606
   0.056814964938076   0.000853651840378
  -0.095769476045198  -0.000539658586765
   0.171281435316937  -0.000185310733967
   0.124508218279233  -0.000507012267202
  -0.031259851147167   0.000158209588393
   0.157833904225375  -0.000659068497033
   0.060002524464489  -0.000043055913204
  -0.093029663054083   0.000501563656065
   0.098308632265035  -0.000025075253169
   0.494951811875837  -0.000142248091097
   0.048640372084702  -0.000183334574160
   0.053581843360593   0.000071918480243
  -0.230053651150724   0.000333671260499
  -0.119993606928346   0.000748074184391
  -0.135684548455450   0.000180669668926
  -0.158781007751851  -0.000334206254317
  -0.087237295466339   0.000063298488164
  -0.061708566455651   0.000257315485750
  -0.117467677399091   0.000215554209878
  -0.159106249462210   0.000276168398820
  -0.060502525685644  -0.000261611841903
  -0.203141751896657   0.000179739856012
   0.021574914571956  -0.000031459737434
  -0.136469982785207   0.000576831939251
   0.130081145773691  -0.000422742179454
  -0.161500934423898  -0.000353733229026
  -0.229662088831325   0.000325595536279
   0.100221747992371  -0.000270485884846
   0.009402652766213   0.000088035751166
   0.480907177561400   0.000052761035119
   0.128376142407644   0.000175335518448
   0.268666264204481  -0.000868400922944
  -0.229305858269162   0.000287270983310
   0.326469466280017  -0.000712744224136
   0.857231754920727  -0.001844383408014
  -0.078077774392654  -0.000339063857904
  -0.044613921546977   0.000191800413270
  -0.132768601374960   0.000254351743972
  -0.065997599999380   0.000555794701992
  -0.077702739959804  -0.000170221339782
   0.207693081007534   0.000288591804189
   0.042955249598396   0.000208889428482
  -0.221704809749248  -0.000149078651431
  -0.109621792993383  -0.000651294729412
  -0.070645177304159   0.000333272917386
   0.652344310803692  -0.000326875013188
   0.061927175220180   0.000750015144641
  -0.403443318356004   0.000193599098125
   0.049019952588051  -0.000327788734089
  -0.246336714858912  -0.000232539485506
   0.026478807095397  -0.000287547502633
  -0.240118068464603   0.000513726875609
   0.085954011414632  -0.000339413047203
  -0.103824061517226   0.000269664256794
  -0.047721788558526   0.000230656882173
  -0.023109989316549  -0.000683984536346
  -0.226351981146894   0.000719611304235
   0.010258976744866   0.000509192314977
   0.150159900745920  -0.000282661141779
   0.024460465603564   0.000238668390784
  -0.109151311456916   0.000248896019675
   0.272961478258719  -0.000341615766689
  -0.122499939526868  -0.000202888248228
   0.220300298360057   0.000030884706724
  -0.257576927251153   0.000271904361347
  -0.246706450633375  -0.000079969893796
   0.043333882485902  -0.000066864571037
  -0.298650916987239   0.000068913147267];

sig1    = 0.038893616375946;
sig2    = 0.000000171929504;
sig12   = -0.000022709714893;

A12opt  = 0;
A11     = @(A12)(sig1  - A12^2)^0.5; 
A21     = @(A12) - (  (sig12^2 - A12^2*sig2)     /    (A11(A12)^2 - A12^2)    )^0.5;
A22     = @(A12) (sig2 - A21(A12)^2)^0.5;

A11opt  = A11(A12opt);
A21opt  = A21(A12opt);
A22opt  = A22(A12opt);

A       = [A11opt A12opt; A21opt A22opt];
SIG     = [sig1 sig12; sig12 sig2];
Achol   = chol(SIG,'lower');

e1 = res(:,1);
e2 = res(:,2);

s2 = (A22opt - A12opt*A21opt/A11opt)^(-1)*(e2 - A21opt/A11opt*e1);
s1 = 1/A11opt*(e1 - A12opt*s2);

s2func = @(A12) (A22(A12) - A12*A21(A12)/A11(A12))^(-1)*(e2 - A21(A12)/A11(A12)*e1);
s1func = @(A12) 1/A11(A12)*(e1 - A12*s2func(A12));

obj    = @(A12) A11(A12)*s1func(A12)'*e2 - A21(A12)*s1func(A12)'*e1;

obj2 = @(A12) obj(A12)^2;
A120 = randn(1,1)*0.01;
[A12_opt, obj_opt] = fmincon(obj2, A120,[],[],[],[],[],[])

A21_opt = A21(A12_opt);
A22_opt = A22(A12_opt);
A11_opt = A11(A12_opt);
A = [A11_opt A12_opt; A21_opt A22_opt];

ss = (inv(A)*res')';
corr(ss,ss)


%obj_vec = 

return


check_e1 = sum(abs(e1 - A11opt*s1 - A12opt*s2));
check_e2 = sum(abs(e2 - A21opt*s1 - A22opt*s2));
% 
% stuff = @(A12) A11(A12)*A22(A12) - A21(A12)*A12;
% 
% check2 = @(A12) A12/A11(A12)*(sig1 - A11(A12)*A12/stuff(A12)*sig12 + A12*A21(A12)/stuff(A12)*sig1) ...
%       - (sig12 - A11(A12)*A12/stuff(A12)*sig2 + A12*A21(A12)/stuff(A12)*sig12);
% 
% A120 = 0.01;
% 
% [A12_opt] = fmincon(check2, A120,[],[],[],[],[],[])
% 
% A21_opt = A21(A12_opt);
% 
% A22_opt = A22(A12_opt);
% 
% A11_opt = A11(A12_opt);
% 
% A = [A11_opt A12_opt; A21_opt A22_opt];

ss = (inv(A)*res')';

corr(ss,ss)

corr(res,res)






























